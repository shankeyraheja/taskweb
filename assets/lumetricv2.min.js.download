function Lumetric(domain,version,fluxOptions,fluxDefaults){const EVENT_VIEW="view",EVENT_CONVERSION="conversion",EVENT_CUSTOM_EVENT="cevent",EVENT_TIME_ON_PAGE="top",ARG_HOST="host",ARG_URL_REWRITE="urlRewrite",ARG_ACTION_LINK_REWRITE="actionLinkRewrite",QUERY_CURRENT_NODE_ID="n",QUERY_REFERRING_NODE_ID="rn",TOKEN_VISITOR_ID="{visitor}",TOKEN_CURRENT_NODE_ID="{current-node-id}",_urlArgs=_getQueryParams(_getDocumentURL()),_eventOverrideArgs={},_scriptHost=domain,_scriptVersion=version,_isActive=!0;var _resolvedTokens={},defaultJSOptions={cookieAllowed:!0,urlRewrite:!0,actionLinkRewrite:!0,timeOnPage:!1,isActive:!0},_fluxOptions=void 0!==fluxOptions&&_isObject(fluxOptions)?Object.assign(defaultJSOptions,fluxOptions):defaultJSOptions;_debug(`Passed fluxOptions object of ${JSON.stringify(_fluxOptions)}`);var _defaultEventArgs=void 0!==fluxDefaults&&_isObject(fluxDefaults)?fluxDefaults:{};function _active(e){_isActive=!!e}function _debug(...e){}function _track(e,t,r){_isObject(t)||(_debug("Events-level arguments null or not object, setting blank"),t={}),_callOnLoaded(function(){switch(e){case EVENT_VIEW:_trackView(t,r);break;case EVENT_CONVERSION:_trackConversion(t,r);break;case EVENT_CUSTOM_EVENT:_trackCustomEvent(t,r);break;default:throw"invalid event: "+e}})}function _trackView(e,t){_debug("initiating _sendEvent for view"),_debug(`Event level args of ${JSON.stringify(e)}`),_debug(`On done callback of ${t}`),_debug(`Default options of ${JSON.stringify(_fluxOptions)}`),_debug(`Default event args of ${JSON.stringify(_defaultEventArgs)}`),_sendEvent(EVENT_VIEW,_buildQueryPayload(EVENT_VIEW,e),t)}function _trackConversion(e,t){_sendEvent(EVENT_CONVERSION,_buildQueryPayload(EVENT_CONVERSION,e),t)}function _trackCustomEvent(e,t){_sendEvent(EVENT_CUSTOM_EVENT,_buildQueryPayload(EVENT_CUSTOM_EVENT,e),t)}function _buildQueryPayload(e,t){let r=Object.assign({},_fluxOptions);switch(void 0!==t&&t.hasOwnProperty("resolveTokens")&&(r.resolveTokens=t.resolveTokens),_debug(`Event level args in buildQueryPayload of ${JSON.stringify(t)}`),e){case EVENT_VIEW:return _debug("Processing switch, returning event view object"),_debug(`Default event args: ${JSON.stringify(_defaultEventArgs)}`),{event:"view",version:_scriptVersion,options:r,event_args:_getViewEventArgs(),url_args:_getViewUrlArgs(t),url:_getDocumentURL(),iframe_url:_getIFrameURL(),referrer:_getReferrerURL()};case EVENT_CONVERSION:return{event:"conversion",version:_scriptVersion,options:r,event_args:_getConversionEventArgs(t),url_args:_getConversionUrlArgs(t),url:_getDocumentURL(),iframe_url:_getIFrameURL(),referrer:_getReferrerURL()};case EVENT_CUSTOM_EVENT:return{event:"cevent",version:_scriptVersion,options:r,event_args:_getCustomEventEventArgs(t),url_args:_getCustomEventUrlArgs(t),url:_getDocumentURL(),iframe_url:_getIFrameURL(),referrer:_getReferrerURL()}}}function _getViewEventArgs(){return _defaultEventArgs}function _getViewUrlArgs(e){let t={..._urlArgs,...e};return t.vid=_getCurrentVisitorId(e),t.resolveTokens&&delete t.resolveTokens,t}function _getConversionUrlArgs(e){let t={..._urlArgs,...e};return t.vid=_getCurrentVisitorId(e),t.resolveTokens&&delete t.resolveTokens,t}function _getConversionEventArgs(e){let t={};return t.pid=e.p?e.p:void 0,t.rev=e.rev?e.rev:void 0,t.tx=e.tx?e.tx:void 0,t.hit=e.hit?e.hit:void 0,t.vid=_getCurrentVisitorId(e)?_getCurrentVisitorId(e):void 0,t}function _getCustomEventUrlArgs(e){let t={..._urlArgs,...e};return t.vid=_getCurrentVisitorId(e),t.resolveTokens&&delete t.resolveTokens,t}function _getCustomEventEventArgs(e){let t={};return t.pid=e.p?e.p:void 0,t.rev=e.rev?e.rev:void 0,t.hit=e.hit?e.hit:void 0,t.vid=_getCurrentVisitorId(e)?_getCurrentVisitorId(e):void 0,t}function _getCurrentVisitorId(e){return e.vid&&_isValidVisitorId(e.vid)?e.vid:_urlArgs.vid&&_isValidVisitorId(_urlArgs.vid)?_urlArgs.vid:void 0}function _defaultCallback(e){_injectArgsIntoActionLinks(e),_urlRewrite(e),_updateMetaReferrerTag()}function _sendEvent(e,t,r){_debug(JSON.stringify(t)),_debug(`Event type: ${e}`),_post(t,function(t){try{_injectHTML(t=JSON.parse(t)),_isObject(t.resolvedTokens)&&(_resolvedTokens=t.resolvedTokens),e===EVENT_VIEW&&_defaultCallback(t),document.dispatchEvent(new CustomEvent("flux"+capitalizeFirstLetter(e))),r&&r(t)}catch(e){console.log(e)}})}function _post(e,t){_isCallable(t)||(t=null);var r=JSON.stringify(e),n=!0;navigator.sendBeacon&&!t&&(n=!navigator.sendBeacon(r)),n&&_xhr(r,t)}function _xhr(e,t){var r=new XMLHttpRequest,n=_getServerURL();r.open("POST",n,!0),r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.withCredentials=!0,_isCallable(t)&&(r.onreadystatechange=function(){4===this.readyState&&200===this.status&&t(this.response)}),r.send(e)}function _set(e,t){}function _get(e){if(_resolvedTokens[e])return _resolvedTokens[e]}function _injectHTML(eventResponse){if(eventResponse&&eventResponse.html){var fragment=document.createDocumentFragment(),tmp=document.createElement("div"),child;for(tmp.innerHTML=eventResponse.html;child=tmp.firstElementChild;)fragment.appendChild(child);for(var scripts=fragment.querySelectorAll("script"),i=0;i<scripts.length;i++){var script=scripts[i];if(script.src){var tag=document.createElement("script");tag.src=script.src,document.head.appendChild(tag)}else eval(script.innerHTML);script.parentNode.removeChild(script)}document.body.appendChild(fragment),delete eventResponse.html}}function _urlRewrite(e){if(_debug("Rewriting URL"),!0===_fluxOptions[ARG_URL_REWRITE]){var t=_suffixURLWithVisitorAndNodeIDs(document.URL,QUERY_CURRENT_NODE_ID,e);history.replaceState({},document.title,t)}}function _updateMetaReferrerTag(){_debug("Updating meta tag");var e=document.querySelector('meta[name="referrer"]');e||((e=document.createElement("meta")).name="referrer",document.getElementsByTagName("head")[0].appendChild(e)),e.content="no-referrer-when-downgrade"}function _injectArgsIntoActionLinks(e){_debug("Rewriting links"),!0===_fluxOptions[ARG_ACTION_LINK_REWRITE]&&(_injectArgsIntoStaticLinks(e),_injectArgsIntoDynamicLinks(e))}function _injectArgsIntoStaticLinks(e){var t=document.getElementsByTagName("a");if(t)for(var r=0;r<t.length;r++)_injectArgsIntoLink(t[r],e)}function _injectArgsIntoDynamicLinks(e){window.MutationObserver?new MutationObserver(function(t){t.forEach(function(t){for(var r=0;r<t.addedNodes.length;r++){var n=t.addedNodes[r];n instanceof HTMLAnchorElement&&_isActionLink(n)&&_injectArgsIntoLink(n,e)}})}).observe(document,{childList:!0,subtree:!0}):setInterval(function(){_injectArgsIntoStaticLinks(e)},1e3)}function _injectArgsIntoLink(e,t){if(t&&_isActionLink(e)){var r=e.getAttribute("href");r.startsWith("http")||(_debug("Relative link detected, prepending https"),r="https://"+r),"localhost:3999"!==_scriptHost&&r.startsWith("http://")&&_debug("Insecure link detected, upgrading to https");var n=_suffixURLWithVisitorAndNodeIDs(r,QUERY_REFERRING_NODE_ID,t);e.setAttribute("href",n),e.setAttribute("referrerpolicy","no-referrer-when-downgrade")}}function _isActionLink(e){var t=e.getAttribute("href");if(t){if(-1!==t.indexOf("/action/"))return!0;if("action"===e.dataset.lum)return!0}return!1}function _suffixURLWithVisitorAndNodeIDs(e,t,r){var n=_getVisitorAndRefNodeIDs(r),i=_getQueryParams(e,!1),o=!1;return n["visitor-id"]&&(i[r.skv]=n["visitor-id"],o=!0),n["referring-node-id"]&&(i[t]=n["referring-node-id"],o=!0),o&&(e=_setQueryParams(e,i,!1)),_debug("_suffixURLWithVisitorAndNodeIDs Url: ",e),e}function _getVisitorAndRefNodeIDs(e){var t=null,r=null;return e.hit?(t=e.hit.VisitorID,r=e.hit.NodeID):e.resolvedTokens&&(t=e.resolvedTokens[TOKEN_VISITOR_ID],r=e.resolvedTokens[TOKEN_CURRENT_NODE_ID]),{"visitor-id":t,"referring-node-id":r}}function _parseURL(e){for(var t=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],r={},n=new RegExp(["(?:([^:\\/?#]+):)?","(?:\\/\\/()(?:(?:()(?:([^:@\\/]*):?([^:@\\/]*))?@)?([^:\\/?#]*)(?::(\\d*))?))?","()","(?:(()(?:(?:[^?#\\/]*\\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)"].join("")).exec(e),i=t.length-1;i>=0;i--)n[i]&&(r[t[i]]=n[i]);return r}function _rebuildURL(e){return(e.scheme?e.scheme+"://":"")+(e.user?e.user+":":"")+(e.pass?e.pass+"@":"")+(e.host||"")+(e.port?":"+e.port:"")+(e.path||"")+(e.query?"?"+e.query:"")+(e.fragment?"#"+e.fragment:"")}function _getArg(e){return void 0!==_urlArgs[e]?_urlArgs[e]:void 0!==_defaultEventArgs[e]?_defaultEventArgs[e]:void 0}function _getServerURL(){return("localhost:3999"===_scriptHost?"http://":"https://")+_scriptHost+"/js/funnel"}function _getDocumentURL(){if(window.top!==window.self)try{return window.top.document.URL}catch(e){}return document.URL}function _getIFrameURL(){return window.top!==window.self?document.URL:""}function _getReferrerURL(){if(window.top!==window.self)try{return window.top.document.referrer}catch(e){}return document.referrer}function _getQueryParams(e,t){void 0===t&&(t=!0);var r={},n=_parseURL(e);if(n.query)for(var i=n.query.split("&"),o=0;o<i.length;o++){var s=i[o].split("="),u=s[0],a=s[1];t&&(u=decodeURIComponent(s[0]),a=decodeURIComponent(s[1])),r[u]=a}return r}function _setQueryParams(e,t,r){void 0===r&&(r=!0);var n=[];for(var i in t){var o=t[i];r&&(i=encodeURIComponent(i),o=encodeURIComponent(o)),n.push(i+"="+o)}var s=_parseURL(e);return s.query=n.join("&"),_rebuildURL(s)}function _isObject(e){return e&&"[object Object]"===Object.prototype.toString.call(e)&&"[object Array]"!==Object.prototype.toString.call(e)}function _isCallable(e){return e&&"[object Function]"===Object.prototype.toString.call(e)}function _callOnLoaded(e){_isCallable(e)&&(document.body?e():document.addEventListener("DOMContentLoaded",e))}function _isValidVisitorId(e){return"string"==typeof e&&e.length>=25&&e.length<=30&&/^[a-zA-Z0-9]+$/.test(e)?e:null}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function _doNothing(){}_defaultEventArgs.vid&&(_defaultEventArgs.vid=void 0),_debug(`Current options are ${JSON.stringify(_fluxOptions)}`),_debug(`Version loaded is ${_scriptVersion}`),_debug(`Domain used is ${_scriptHost}`),_debug(`Server URL is ${_getServerURL()}`);var proto={track:_isActive?function(e,t,r){return _track(e,t,r)}:_doNothing,set:_isActive?function(e,t){return _set(e,t)}:_doNothing,get:function(e){return _get(e)},active:function(e){return _active(e)}};return proto}